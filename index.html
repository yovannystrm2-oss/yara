<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Almac√©n - Esc√°ner Corregido</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
        }

        /* CONTENEDOR DE C√ÅMARA CORREGIDO */
        .scanner-container {
            position: relative;
            width: 100%;
            height: 300px; /* Altura fija para mejor control */
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        #interactive {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important; /* Esto es clave para que ocupe todo el espacio */
        }

        /* Overlay para gu√≠a de escaneo */
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Permite interactuar con la c√°mara */
        }

        .scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 150px;
            border: 3px solid #e74c3c;
            border-radius: 10px;
            background: rgba(231, 76, 60, 0.1);
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #e74c3c;
            top: 50%;
            animation: scan 1.5s infinite ease-in-out;
            box-shadow: 0 0 10px #e74c3c;
        }

        @keyframes scan {
            0%, 100% { 
                top: 20%; 
                opacity: 1;
            }
            50% { 
                top: 80%; 
                opacity: 0.7;
            }
        }

        .scanner-instructions {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-size: 14px;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .status {
            padding: 10px;
            text-align: center;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.ready {
            background: #cce7ff;
            color: #004085;
        }

        .status.scanning {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .product-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .camera-fix {
            text-align: center;
            padding: 10px;
            background: #fff3cd;
            color: #856404;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∑ ESC√ÅNER CORREGIDO - La Buena Familia</h1>
            <p>C√°mara completa sin bordes negros</p>
        </div>

        <div class="camera-fix">
            üîß <strong>Problema solucionado:</strong> La c√°mara ahora ocupa todo el espacio
        </div>

        <!-- CONTENEDOR DE C√ÅMARA MEJORADO -->
        <div class="scanner-container">
            <div id="interactive"></div>
            <div class="scan-overlay">
                <div class="scan-guide"></div>
                <div class="scan-line"></div>
                <div class="scanner-instructions">
                    üìç Enfoca el c√≥digo de barras dentro del marco rojo
                </div>
            </div>
        </div>

        <div class="status ready" id="scanStatus">
            üîµ Listo para escanear - Presiona INICIAR
        </div>

        <div style="text-align: center; margin: 15px 0;">
            <button class="btn btn-success" onclick="initScanner()">
                üì∑ INICIAR C√ÅMARA
            </button>
            <button class="btn btn-danger" onclick="stopScanner()">
                ‚èπÔ∏è DETENER C√ÅMARA
            </button>
            <button class="btn" onclick="switchCamera()">
                üîÑ CAMBIAR C√ÅMARA
            </button>
        </div>

        <div id="scanResult" class="product-info" style="display: none;">
            <h3>üìã PRODUCTO ENCONTRADO</h3>
            <div class="info-item">
                <span class="info-label">C√≥digo:</span>
                <span class="info-value" id="scanCode">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Producto:</span>
                <span class="info-value" id="scanProduct">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Peso:</span>
                <span class="info-value" id="scanWeight">-</span>
            </div>
            <div class="info-label">Precio Compra:</span>
                <span class="info-value" id="scanPrice">-</span>
            </div>
        </div>

        <!-- SECCI√ìN DE AJUSTES -->
        <div class="product-info">
            <h3>‚öôÔ∏è AJUSTES DE C√ÅMARA</h3>
            <div style="margin: 10px 0;">
                <label>Resoluci√≥n: </label>
                <select id="resolutionSelect" onchange="changeResolution()">
                    <option value="hd">Alta (1280x720)</option>
                    <option value="medium" selected>Media (640x480)</option>
                    <option value="low">Baja (320x240)</option>
                </select>
            </div>
            <button class="btn" onclick="testFullscreen()">
                üñ•Ô∏è MODO PANTALLA COMPLETA
            </button>
        </div>
    </div>

    <script>
        let scannerActive = false;
        let currentFacingMode = 'environment';
        let currentResolution = 'medium';

        // CONFIGURACIONES DE RESOLUCI√ìN
        const resolutionConfigs = {
            'hd': { width: 1280, height: 720 },
            'medium': { width: 640, height: 480 },
            'low': { width: 320, height: 240 }
        };

        function getScannerConfig() {
            const resolution = resolutionConfigs[currentResolution];
            
            return {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: resolution.width,
                        height: resolution.height,
                        facingMode: currentFacingMode,
                        aspectRatio: { min: 1, max: 2 }
                    }
                },
                decoder: {
                    readers: ["code_128_reader"]
                },
                locator: {
                    patchSize: "medium",
                    halfSample: false
                },
                frequency: 10,
                numOfWorkers: 1,
            };
        }

        function initScanner() {
            if (scannerActive) return;

            const status = document.getElementById('scanStatus');
            status.className = 'status scanning';
            status.innerHTML = 'üîÑ INICIANDO C√ÅMARA...';

            // Limpiar contenedor primero
            const interactive = document.getElementById('interactive');
            interactive.innerHTML = '';

            Quagga.init(getScannerConfig(), function(err) {
                if (err) {
                    status.className = 'status error';
                    status.innerHTML = '‚ùå ERROR: ' + err.message;
                    
                    // Mostrar errores comunes y soluciones
                    if (err.name === 'NotAllowedError') {
                        status.innerHTML += '<br>üí° Permiso denegado. Permite el acceso a la c√°mara.';
                    } else if (err.name === 'NotFoundError') {
                        status.innerHTML += '<br>üí° C√°mara no encontrada.';
                    } else if (err.name === 'NotSupportedError') {
                        status.innerHTML += '<br>üí° Navegador no compatible.';
                    }
                    return;
                }
                
                Quagga.start();
                scannerActive = true;
                status.className = 'status scanning';
                status.innerHTML = 'üéØ C√ÅMARA ACTIVA - Escaneando...';
                
                // Ajustar el video para que ocupe todo el espacio
                setTimeout(() => {
                    const videoElement = interactive.querySelector('video');
                    if (videoElement) {
                        videoElement.style.width = '100%';
                        videoElement.style.height = '100%';
                        videoElement.style.objectFit = 'cover';
                    }
                }, 1000);
            });

            Quagga.onDetected(function(result) {
                if (!scannerActive) return;
                
                const code = result.codeResult.code;
                const status = document.getElementById('scanStatus');
                status.className = 'status ready';
                status.innerHTML = '‚úÖ C√ìDIGO DETECTADO: ' + code;
                
                if (navigator.vibrate) navigator.vibrate(100);
                searchProduct(code);
            });

            Quagga.onProcessed(function(result) {
                if (!result) {
                    // Asegurar que el video ocupe todo el espacio
                    const videoElement = document.querySelector('#interactive video');
                    if (videoElement) {
                        videoElement.style.width = '100%';
                        videoElement.style.height = '100%';
                        videoElement.style.objectFit = 'cover';
                    }
                }
            });
        }

        function stopScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                
                const status = document.getElementById('scanStatus');
                status.className = 'status ready';
                status.innerHTML = '‚è∏Ô∏è C√ÅMARA DETENIDA - Presiona INICIAR';
                
                // Limpiar el contenedor
                document.getElementById('interactive').innerHTML = '';
            }
        }

        function switchCamera() {
            if (scannerActive) {
                stopScanner();
                currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                setTimeout(initScanner, 500);
            } else {
                currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                const status = document.getElementById('scanStatus');
                status.innerHTML = `üîÑ C√°mara cambiada a: ${currentFacingMode === 'environment' ? 'Trasera' : 'Frontal'}`;
            }
        }

        function changeResolution() {
            currentResolution = document.getElementById('resolutionSelect').value;
            if (scannerActive) {
                stopScanner();
                setTimeout(initScanner, 500);
            }
        }

        function testFullscreen() {
            const scannerContainer = document.querySelector('.scanner-container');
            
            if (!document.fullscreenElement) {
                if (scannerContainer.requestFullscreen) {
                    scannerContainer.requestFullscreen();
                } else if (scannerContainer.webkitRequestFullscreen) {
                    scannerContainer.webkitRequestFullscreen();
                } else if (scannerContainer.msRequestFullscreen) {
                    scannerContainer.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        function searchProduct(code) {
            const inventory = JSON.parse(localStorage.getItem('carniceriaInventory') || '[]');
            const product = inventory.find(item => item.code === code);

            const resultDiv = document.getElementById('scanResult');
            
            if (product) {
                document.getElementById('scanCode').textContent = product.code;
                document.getElementById('scanProduct').textContent = getProductName(product.type);
                document.getElementById('scanWeight').textContent = product.weight + ' kg';
                document.getElementById('scanPrice').textContent = 'S/. ' + product.pricePerKilo + '/kg';
                
                resultDiv.style.display = 'block';
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            } else {
                const status = document.getElementById('scanStatus');
                status.className = 'status error';
                status.innerHTML = '‚ùå PRODUCTO NO ENCONTRADO - C√≥digo: ' + code;
                resultDiv.style.display = 'none';
            }
        }

        function getProductName(type) {
            const names = {
                'CHA-LOMO': 'Lomo de Chancho',
                'CHA-COST': 'Costilla de Chancho',
                'CHA-PIER': 'Pierna de Chancho',
                'CHA-PANC': 'Panceta de Chancho',
                'CHA-JAM': 'Jam√≥n de Chancho',
                'CHA-OTRO': 'Otro Corte de Chancho'
            };
            return names[type] || 'Producto de Chancho';
        }

        // Cargar productos de prueba si no existen
        window.addEventListener('load', function() {
            const inventory = JSON.parse(localStorage.getItem('carniceriaInventory') || '[]');
            if (inventory.length === 0) {
                const defaultProduct = {
                    code: 'CHA-LOMO-DEMO-001',
                    type: 'CHA-LOMO',
                    weight: 5.0,
                    pricePerKilo: 15.00,
                    purchaseDate: new Date().toISOString().split('T')[0],
                    expiryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    totalValue: '75.00',
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('carniceriaInventory', JSON.stringify([defaultProduct]));
            }
        });

        // Detener c√°mara al salir
        window.addEventListener('beforeunload', stopScanner);
    </script>
</body>
</html>
