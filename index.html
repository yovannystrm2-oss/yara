<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Almac√©n - Esc√°ner R√°pido</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .scanner-container {
            position: relative;
            width: 100%;
            height: 250px; /* M√°s peque√±o para mejor rendimiento */
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        #interactive {
            width: 100%;
            height: 100%;
        }

        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #e74c3c;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7);
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #e74c3c;
            top: 50%;
            animation: scan 1.5s infinite ease-in-out;
            box-shadow: 0 0 10px #e74c3c;
        }

        @keyframes scan {
            0%, 100% { 
                top: 20%; 
                opacity: 1;
            }
            50% { 
                top: 80%; 
                opacity: 0.7;
            }
        }

        .scanner-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 10;
        }

        .scanner-guide .box {
            width: 250px;
            height: 100px;
            border: 2px solid #e74c3c;
            margin-bottom: 10px;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .status {
            padding: 10px;
            text-align: center;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.scanning {
            background: #d4edda;
            color: #155724;
        }

        .status.ready {
            background: #cce7ff;
            color: #004085;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .product-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .info-item {
            margin-bottom: 8px;
            padding: 5px;
        }

        .info-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .info-value {
            color: #e74c3c;
        }

        .performance-tips {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ ESC√ÅNER R√ÅPIDO - La Buena Familia</h1>
            <p>Optimizado para m√°xima velocidad</p>
        </div>

        <div class="performance-tips">
            üí° <strong>Consejos para escaneo r√°pido:</strong><br>
            ‚Ä¢ Buena iluminaci√≥n ‚Ä¢ Enfocar bien ‚Ä¢ C√≥digo limpio ‚Ä¢ Acercar suficiente
        </div>

        <div class="scanner-container">
            <div id="interactive"></div>
            <div class="scan-overlay">
                <div class="scan-line"></div>
            </div>
            <div class="scanner-guide">
                <div class="box"></div>
                <p>Coloca el c√≥digo aqu√≠</p>
            </div>
        </div>

        <div class="status ready" id="scanStatus">
            üîµ Listo para escanear - Presiona INICIAR
        </div>

        <div style="text-align: center; margin: 15px 0;">
            <button class="btn btn-success" onclick="initFastScanner()">
                ‚ö° INICIAR ESC√ÅNER R√ÅPIDO
            </button>
            <button class="btn btn-danger" onclick="stopScanner()">
                ‚èπÔ∏è DETENER
            </button>
            <button class="btn" onclick="testScanner()">
                üß™ PROBAR CON C√ìDIGO DE EJEMPLO
            </button>
        </div>

        <div id="scanResult" class="product-info" style="display: none;">
            <h3>üìã PRODUCTO ENCONTRADO</h3>
            <div class="info-item">
                <span class="info-label">C√≥digo:</span>
                <span class="info-value" id="scanCode">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Producto:</span>
                <span class="info-value" id="scanProduct">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Peso:</span>
                <span class="info-value" id="scanWeight">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Precio Compra:</span>
                <span class="info-value" id="scanPrice">-</span>
            </div>
        </div>

        <!-- SECCI√ìN PARA CREAR C√ìDIGOS DE PRUEBA -->
        <div class="product-info">
            <h3>üéØ CREAR C√ìDIGOS DE PRUEBA</h3>
            <button class="btn" onclick="createTestProducts()">
                GENERAR PRODUCTOS DE PRUEBA
            </button>
            <div id="testBarcodes" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        let scannerActive = false;
        let lastScannedCode = '';
        let scanTimeout;

        // CONFIGURACI√ìN SUPER OPTIMIZADA
        const scannerConfig = {
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    width: 320,    // Resoluci√≥n m√°s baja = m√°s r√°pido
                    height: 240,   // Resoluci√≥n m√°s baja = m√°s r√°pido
                    facingMode: "environment",
                    aspectRatio: { min: 1, max: 2 }
                }
            },
            decoder: {
                readers: [
                    "code_128_reader",  // Solo Code128 para mayor velocidad
                ],
                multiple: false,        // No buscar m√∫ltiples c√≥digos
            },
            locator: {
                patchSize: "medium",    // Balance entre velocidad y precisi√≥n
                halfSample: false       // M√°s velocidad
            },
            frequency: 10,              // Frames por segundo (reducido para velocidad)
            numOfWorkers: 1,            // Solo un worker para m√≥viles
        };

        function initFastScanner() {
            if (scannerActive) return;

            const status = document.getElementById('scanStatus');
            status.className = 'status scanning';
            status.innerHTML = 'üîÑ INICIANDO ESC√ÅNER...';

            // Configuraci√≥n ultra r√°pida
            const fastConfig = {
                ...scannerConfig,
                frequency: 15,  // Un poco m√°s de FPS pero estable
                locator: {
                    patchSize: "large",  // M√°s r√°pido en c√≥digos grandes
                    halfSample: false
                }
            };

            Quagga.init(fastConfig, function(err) {
                if (err) {
                    status.className = 'status error';
                    status.innerHTML = '‚ùå ERROR: ' + err.message;
                    return;
                }
                
                Quagga.start();
                scannerActive = true;
                status.className = 'status scanning';
                status.innerHTML = 'üéØ ESCANEANDO - Enfoca el c√≥digo de barras';
                
                // Limpiar resultado anterior
                document.getElementById('scanResult').style.display = 'none';
                lastScannedCode = '';
            });

            // DETECCI√ìN OPTIMIZADA - con anti-rebote
            Quagga.onDetected(function(result) {
                if (!scannerActive) return;
                
                const code = result.codeResult.code;
                
                // Evitar escaneos duplicados r√°pidos
                if (code === lastScannedCode) return;
                
                lastScannedCode = code;
                
                // Feedback inmediato
                const status = document.getElementById('scanStatus');
                status.className = 'status ready';
                status.innerHTML = '‚úÖ C√ìDIGO DETECTADO - Procesando...';
                
                // Vibraci√≥n r√°pida
                if (navigator.vibrate) navigator.vibrate(100);
                
                // Buscar producto inmediatamente
                searchProduct(code);
                
                // Peque√±a pausa antes de permitir nuevo escaneo
                clearTimeout(scanTimeout);
                scanTimeout = setTimeout(() => {
                    lastScannedCode = '';
                    status.className = 'status scanning';
                    status.innerHTML = 'üéØ LISTO - Escanea otro c√≥digo';
                }, 1500);
            });

            // Manejar errores de c√°mara
            Quagga.onProcessed(function(result) {
                if (!result) {
                    document.getElementById('scanStatus').innerHTML = 'üîç BUSCANDO C√ìDIGOS...';
                }
            });
        }

        function stopScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                clearTimeout(scanTimeout);
                
                const status = document.getElementById('scanStatus');
                status.className = 'status ready';
                status.innerHTML = '‚è∏Ô∏è ESC√ÅNER DETENIDO - Presiona INICIAR';
            }
        }

        function searchProduct(code) {
            const inventory = JSON.parse(localStorage.getItem('carniceriaInventory') || '[]');
            const product = inventory.find(item => item.code === code);

            const resultDiv = document.getElementById('scanResult');
            const status = document.getElementById('scanStatus');
            
            if (product) {
                document.getElementById('scanCode').textContent = product.code;
                document.getElementById('scanProduct').textContent = getProductName(product.type);
                document.getElementById('scanWeight').textContent = product.weight + ' kg';
                document.getElementById('scanPrice').textContent = 'S/. ' + product.pricePerKilo + '/kg';
                
                resultDiv.style.display = 'block';
                status.className = 'status success';
                status.innerHTML = '‚úÖ PRODUCTO ENCONTRADO - ' + getProductName(product.type);
                
                // Scroll autom√°tico al resultado
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            } else {
                status.className = 'status error';
                status.innerHTML = '‚ùå PRODUCTO NO ENCONTRADO - C√≥digo: ' + code;
                resultDiv.style.display = 'none';
            }
        }

        function getProductName(type) {
            const names = {
                'CHA-LOMO': 'Lomo de Chancho',
                'CHA-COST': 'Costilla de Chancho',
                'CHA-PIER': 'Pierna de Chancho',
                'CHA-PANC': 'Panceta de Chancho',
                'CHA-JAM': 'Jam√≥n de Chancho',
                'CHA-OTRO': 'Otro Corte de Chancho'
            };
            return names[type] || 'Producto de Chancho';
        }

        // FUNCI√ìN DE PRUEBA R√ÅPIDA
        function testScanner() {
            const testCodes = ['CHA-LOMO-123', 'CHA-COST-456', 'CHA-PIER-789'];
            const randomCode = testCodes[Math.floor(Math.random() * testCodes.length)];
            
            const status = document.getElementById('scanStatus');
            status.className = 'status ready';
            status.innerHTML = 'üß™ PROBANDO CON: ' + randomCode;
            
            searchProduct(randomCode);
        }

        // CREAR PRODUCTOS DE PRUEBA
        function createTestProducts() {
            const testProducts = [
                { type: 'CHA-LOMO', weight: 5.5, price: 15.50 },
                { type: 'CHA-COST', weight: 3.2, price: 12.80 },
                { type: 'CHA-PIER', weight: 7.1, price: 14.20 }
            ];

            let inventory = JSON.parse(localStorage.getItem('carniceriaInventory') || '[]');
            const testBarcodesDiv = document.getElementById('testBarcodes');
            testBarcodesDiv.innerHTML = '<h4>C√≥digos de Prueba Creados:</h4>';

            testProducts.forEach((product, index) => {
                const code = `${product.type}-TEST-${Date.now()}-${index}`;
                
                const productData = {
                    code: code,
                    type: product.type,
                    weight: product.weight,
                    pricePerKilo: product.price,
                    purchaseDate: new Date().toISOString().split('T')[0],
                    expiryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    totalValue: (product.weight * product.price).toFixed(2),
                    createdAt: new Date().toISOString()
                };

                inventory.push(productData);

                // Mostrar c√≥digo de barras de prueba
                const barcodeDiv = document.createElement('div');
                barcodeDiv.style.margin = '10px 0';
                barcodeDiv.style.padding = '10px';
                barcodeDiv.style.border = '1px solid #ddd';
                barcodeDiv.style.borderRadius = '5px';
                
                barcodeDiv.innerHTML = `
                    <strong>${getProductName(product.type)}</strong><br>
                    <small>C√≥digo: ${code}</small><br>
                    <svg id="barcode-${index}"></svg>
                `;
                
                testBarcodesDiv.appendChild(barcodeDiv);
                
                // Generar c√≥digo de barras visual
                JsBarcode(`#barcode-${index}`, code, {
                    format: "CODE128",
                    width: 2,
                    height: 40,
                    displayValue: true
                });
            });

            localStorage.setItem('carniceriaInventory', JSON.stringify(inventory));
            
            const status = document.getElementById('scanStatus');
            status.className = 'status success';
            status.innerHTML = '‚úÖ PRODUCTOS DE PRUEBA CREADOS - Ya puedes escanearlos!';
        }

        // Detener esc√°ner al salir
        window.addEventListener('beforeunload', stopScanner);

        // Cargar algunos productos de prueba autom√°ticamente si no hay inventario
        window.addEventListener('load', function() {
            const inventory = JSON.parse(localStorage.getItem('carniceriaInventory') || '[]');
            if (inventory.length === 0) {
                // Crear un producto de prueba por defecto
                const defaultProduct = {
                    code: 'CHA-LOMO-DEMO-001',
                    type: 'CHA-LOMO',
                    weight: 5.0,
                    pricePerKilo: 15.00,
                    purchaseDate: new Date().toISOString().split('T')[0],
                    expiryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    totalValue: '75.00',
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('carniceriaInventory', JSON.stringify([defaultProduct]));
            }
        });
    </script>
</body>
</html>
